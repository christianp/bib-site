<?php

global $latex_accents;
$latex_accents = array(
    '\\~{}' => '~',
    '\\\'{i}' => 'í',
    '\\k{i}' => 'į',
    '\\`{I}' => 'Ì',
    '\\"{o}' => 'ö',
    '\\={I}' => 'Ī',
    '\\`{a}' => 'à',
    '\\v{T}' => 'Ť',
    '\\H{O}' => 'Ő',
    '\\k{I}' => 'Į',
    '\\"{y}' => 'ÿ',
    '\\"{O}' => 'Ö',
    '\\\'{Y}' => 'Ý',
    '\\u{u}' => 'ў',
    '\\u{G}' => 'Ğ',
    '\\.{E}' => 'Ė',
    '\\.{z}' => 'ż',
    '\\v{t}' => 'ť',
    '\\H{o}' => 'ő',
    '\\\'{y}' => 'ý',
    '\\.{e}' => 'ė',
    '\\\'{L}' => 'Ĺ',
    '\\.{Z}' => 'Ż',
    '\\\'{e}' => 'é',
    '\\`{U}' => 'Ù',
    '\\\'{l}' => 'ĺ',
    '\\v{L}' => 'Ľ',
    '\\c{s}' => 'ş',
    '\\\'{s}' => 'ś',
    '\\~{A}' => 'Ã',
    '\\k{e}' => 'ę',
    '\\\'{z}' => 'ź',
    '\\\'{E}' => 'É',
    '\\~{n}' => 'ñ',
    '\\u{i}' => 'й',
    '\\c{S}' => 'Ş',
    '\\c{N}' => 'Ņ',
    '\\H{u}' => 'ű',
    '\\v{n}' => 'ň',
    '\\\'{S}' => 'Ś',
    '\\={U}' => 'Ū',
    '\\~{O}' => 'Õ',
    '\\\'{Z}' => 'Ź',
    '\\v{E}' => 'Ě',
    '\\\'{R}' => 'Ŕ',
    '\\H{U}' => 'Ű',
    '\\v{N}' => 'Ň',
    '\\v{s}' => 'š',
    '\\"{U}' => 'Ü',
    '\\c{n}' => 'ņ',
    '\\k{U}' => 'Ų',
    '\\c{R}' => 'Ŗ',
    '\\\'{A}' => 'Á',
    '\\~{o}' => 'õ',
    '\\v{e}' => 'ě',
    '\\v{S}' => 'Š',
    '\\u{A}' => 'Ă',
    '\\"{u}' => 'ü',
    '\\v{z}' => 'ž',
    '\\r{U}' => 'Ů',
    '\\`{O}' => 'Ò',
    '\\={u}' => 'ū',
    '\\c{K}' => 'Ķ',
    '\\k{u}' => 'ų',
    '\\`{o}' => 'ò',
    '\\"{I}' => 'Ï',
    '\\v{D}' => 'Ď',
    '\\.{G}' => 'Ġ',
    '\\r{u}' => 'ů',
    '\\`{u}' => 'ù',
    '\\v{c}' => 'č',
    '\\c{k}' => 'ķ',
    '\\.{g}' => 'ġ',
    '\\\'{N}' => 'Ń',
    '\\`{e}' => 'э',
    '\\c{T}' => 'Ţ',
    '\\v{d}' => 'ď',
    '\\"{e}' => 'ё',
    '\\\'{I}' => 'Í',
    '\\v{R}' => 'Ř',
    '\\k{a}' => 'ą',
    '\\`{A}' => 'À',
    '\\\'{n}' => 'ń',
    '\\~{N}' => 'Ñ',
    '\\.{C}' => 'Ċ',
    '\\~{u}' => 'ũ',
    '\\`{E}' => 'Э',
    '\\~{a}' => 'ã',
    '\\c{t}' => 'ţ',
    '\\={o}' => 'ō',
    '\\v{r}' => 'ř',
    '\\={A}' => 'Ā',
    '\\.{c}' => 'ċ',
    '\\~{U}' => 'Ũ',
    '\\k{A}' => 'Ą',
    '\\"{a}' => 'ä',
    '\\u{U}' => 'Ў',
    '\\={O}' => 'Ō',
    '\\c{C}' => 'Ç',
    '\\\'{c}' => 'ć',
    '\\"{A}' => 'Ä',
    '\\\'{u}' => 'ú',
    '\\c{c}' => 'ç',
    '\\\'{C}' => 'Ć',
    '\\v{l}' => 'ľ',
    '\\u{a}' => 'ă',
    '\\v{Z}' => 'Ž',
    '\\\'{o}' => 'ó',
    '\\c{G}' => 'Ģ',
    '\\v{C}' => 'Č',
    '\\"{E}' => 'Ё',
    '\\={a}' => 'ā',
    '\\c{l}' => 'ļ',
    '\\\'{a}' => 'á',
    '\\={E}' => 'Ē',
    '\\u{g}' => 'ğ',
    '\\\'{O}' => 'Ó',
    '\\\'{g}' => 'ǵ',
    '\\u{I}' => 'Й',
    '\\c{L}' => 'Ļ',
    '\\k{E}' => 'Ę',
    '\\.{I}' => 'İ',
    '\\~{I}' => 'Ĩ',
    '\\c{r}' => 'ŗ',
    '\\\'{r}' => 'ŕ',
    '\\"{Y}' => 'Ÿ',
    '\\={e}' => 'ē',
    '\\\'{U}' => 'Ú',
    '\\k{}' => '˛',
    '\\={}' => '‾',
    '\\H{}' => '˝',
    '\\c{}' => '¸',
    '\\d{}' => '̣',
    '\\b{}' => 'ˍ',
    '\\t{}' => '͡',
    '\\r{}' => '˚',

);

global $latex_specials;
$latex_specials = array(
    'o' => 'ø',
	'$' => '$',
	'_' => '_',
	'&' => '&',
	'#' => '#',
	'%' => '%',
	'l' => 'ł',
);

class BibEntry {
	function BibEntry($type,$key,$fields) {
		$this->key = $key;
		$this->type = $type;
		$this->fields = $fields;
		$this->title = isset($this->fields['title']) ? $this->fields['title'] : '';
		$this->author = isset($this->fields['author']) ? $this->fields['author'] : '';
		if(array_key_exists('url',$this->fields) && $this->fields['url']!=='') {
			$this->urls = explode(" ",$this->fields['url']);
		} else {
			$this->urls = array();
		}
	}

	function as_bib() {
		$out = "@{$this->type}{{$this->key},\n";
		$fs = array();
		foreach($this->fields as $name => $value) {
			$fs[] = "\t{$name} = ".bib_string($value);
		}
		$out .= implode(",\n",$fs);
		$out .= "\n}";
		return $out;
	}
}

class BibDatabase {
    function BibDatabase($source) {
        $records = array();
        $acc = 0;
        while($res=parse_record($source)) {
            list($record,$source) = $res;
            while($record->key=='' || array_key_exists($record->key,$records)) {
                $acc += 1;
                $record->key = "item{$acc}";
            }
            $records[$record->key] = $record;
        }
        $this->records = $records;
    }

    function as_bib() {
        $o = array();
        foreach($this->records as $key=>$entry) {
            $o[] = $entry->as_bib();
        }
        return implode("\n",$o);
    }

    function delete_record($record) {
        unset($this->records[$record->key]);
    }
}

function parse_record($source) {
	$osource = $source;
    $m = preg_match('/^[^@]*@(?P<type>[^{}\s,=#%]+)\{(?P<key>[^{}\s,=#%]*),/mx',$source,$matches,PREG_OFFSET_CAPTURE);
    if($m) {
        $offset = $matches[0][1]+strlen($matches[0][0]);
        $type = $matches['type'][0];
        $key = $matches['key'][0];
        $source = substr($source,$offset);
        $fields = array();
        while(preg_match('/\A[\n\r\s]*(?P<name>[^{}\s,=#%]+)[\n\r\s]*=[\n\r\s]*/mx',$source,$matches,PREG_OFFSET_CAPTURE)) {
            $name = $matches['name'][0];
            $offset = $matches[0][1]+strlen($matches[0][0]);
            $source = substr($source,$offset);
            if(preg_match('/\A\d+/',$source,$matches)) {
                $value = $matches[0];
                $source = substr($source,strlen($value));
            } else if(preg_match('/\A"([^"]*)"/',$source,$matches)) {
                $value = $matches[1];
                $source = substr($source,strlen($matches[0]));
            } else if(preg_match('/\A\{/',$source)) {
                $res= parse_braced(substr($source,1));
                if($res===false) {
                    return false;
                }
                list($value,$source) = $res;
            }
            $fields[$name] = $value;
            if(preg_match('/\A[\n\r\s]*,[\n\r\s]*/',$source,$matches)) {
                $source = substr($source,strlen($matches[0]));
            } else {
                break;
            }
        }
        if(preg_match('/\A[\n\r\s]*\}[\n\r\s]*/',$source,$matches)) {
            $source = substr($source,strlen($matches[0]));
        } else {
            print("No end of record\n");
            return false;
        }
        return array(
			new BibEntry($type,$key,$fields),
            $source
        );
    }
}

function parse_braced($source) {
    global $latex_accents;
    global $latex_specials;
    $osource = substr($source,0);
    $text = "";
    while(preg_match('/\A(?:(?P<escaped>(?P<accent>)\\\[\'"`~]\{(?P<letter>[^}]?)\})|(?P<escape_special>\{\\\(?P<special>.)(?:\{\})?\\})|(?P<text>(?:[\n\r\s]|[^\\{}])+)|(?P<brace>\{))/m',$source,$matches)) {
        $source = substr($source,strlen($matches[0]));
        if($matches['escaped']!='') {
            $text .= $latex_accents[$matches['escaped']];
        } else if($matches['escape_special']) {
            if(array_key_exists($matches['special'],$latex_specials)) {
                $text .= $latex_specials[$matches['special']];
            } else {
                $text .= $matches['special'];
            }
        } else if($matches['text']!=='') {
            $t = $matches['text'];
            $t = str_replace('\\backslash','\\',$t);
            $text .= $t;
        } else if(array_key_exists('brace',$matches)){
            $res = parse_braced($source);
            if($res===false) {
                return false;
            }
            list($itext,$source) = $res;
            $text .= $itext;
        }
    }
    if(substr($source,0,1)=="}") {
        return array($text,substr($source,1));
    } else {
        print("Failed brace\n");
        return false;
    }
}

function bib_string($str) {
	global $latex_accents;
	global $latex_specials;
	$str = str_replace('\\','\\backslash',$str);
    $str = preg_replace('/[{}]/','{\\\$0}',$str);
	foreach($latex_accents as $escape=>$chr) {
		$str = str_replace($chr,$escape,$str);
	}
	foreach($latex_specials as $escape=>$chr) {
		$str = str_replace($chr,'{\\'.$escape.'}',$str);
	}
	return "{{$str}}";
}
